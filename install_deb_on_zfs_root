install debian 13 on zfs root
create new user with sudo on live system
install ssh
connect to live system from laptop by ssh
sudo -i
nano /etc/apt/sources.list
deb http://deb.debian.org/debian trixie main contrib non-free-firmware
deb http://deb.debian.org/debian trixie-updates main contrib non-free-firmware
deb http://security.debian.org/debian-security trixie-security main contrib non-free-firmware
apt update
apt install debootstrap gdisk zfsutils-linux grub2
apt install linux-headers-$(uname -r) build-essential dkms
dkms autoinstall -k "$(uname -r)"
modprobe zfs

pool labelclear -f /dev/nvme0n1
wipefs -a /dev/nvme0n1
sgdisk --zap-all /dev/nvme0n1
sgdisk -n1:1M:+512M -t1:EF00 /dev/nvme4n1   # EFI System Partition
sgdisk -n2:0:+1G    -t2:BF01 /dev/nvme4n1   # boot
sgdisk -n3:0:0      -t3:BF00 /dev/nvme4n1   # ZFS root

mkfs.fat -F 32 /dev/nvme0n1p1
mkfs.ext4 /dev/dev/nvme0n1p2
zpool create \
    -o ashift=12 \
    -o autotrim=on \
    -O normalization=formD \
    -O acltype=posixacl \
    -O xattr=sa \
    -O dnodesize=auto \
    -O canmount=off \
    -O compression=lz4 \
    -O relatime=on \
    -O mountpoint=none -R /mnt POOLNAME /dev/nvme0n1p3

zfs create -o canmount=noauto -o mountpoint=/ POOLNAME/root
zfs mount POOLNAME/root
zfs create -o mountpoint=/home POOLNAME/home
zfs create -o mountpoint=/var POOLNAME/var
zfs create -o mountpoint=/var/log POOLNAME/var/log
zfs create -o mountpoint=/var/cache POOLNAME/var/cache
zfs create -o mountpoint=/var/lib POOLNAME/var/lib
zfs create -o mountpoint=/var/spool POOLNAME/var/spool
zfs create -o mountpoint=/srv POOLNAME/srv
zfs create -o mountpoint=/opt POOLNAME/opt

mkdir /mnt/boot; mount /dev/nvme0n1p2 /mnt/boot 
mkdir /mnt/boot/efi; mount /dev/nvme1n1p1 /mnt/boot/efi

debootstrap trixie /mnt
zfs set devices=off POOLNAME

echo HOSTNAME > /mnt/hostname
echo 127.0.0.1 localhost HOSTNAME > /mnt/hosts

nano /mnt/etc/apt/sources.list
deb http://deb.debian.org/debian trixie main contrib non-free-firmware
deb http://deb.debian.org/debian trixie-updates main contrib non-free-firmware
deb http://security.debian.org/debian-security trixie-security main contrib non-free-firmware

mount --rbind /dev  /mnt/dev
mount --rbind /proc /mnt/proc
mount --rbind /sys  /mnt/sys
chroot /mnt /bin/bash --login

date -s "YYYY-MM-DD HH:MM:SS"
apt install locales sudo -y


locale-gen --purge "en_US.UTF-8"
update-locale LANG=en_US.UTF-8 LANGUAGE=en_US
dpkg-reconfigure --frontend noninteractive locales
dpkg-reconfigure tzdata

adduser user
usermod -aG sudo user
